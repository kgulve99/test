trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  servicenowConnection: '<Your-ServiceNow-Connection-Name>'
  changeRequestSysId: ''
  changeRequestState: ''

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    steps:
    - script: echo "Building the project..."
      displayName: 'Build the project'

- stage: Commit
  displayName: 'Commit Stage'
  dependsOn: Build
  jobs:
  - job: CommitJob
    steps:
    - script: echo "Committing the build artifacts..."
      displayName: 'Commit the build artifacts'

- stage: Deploy
  displayName: 'Deploy Stage'
  dependsOn: Commit
  jobs:
  - job: DeployJob
    steps:
    - task: ServiceNowCreateChangeRequest@2
      inputs:
        connectedServiceName: $(servicenowConnection)
        changeRequestType: 'normal'  # Specify the type of change request (e.g., 'normal', 'emergency', 'standard')
        changeRequestDetails: |
          {
            "short_description": "Deployment Change Request",
            "description": "This change request is created automatically during the deployment stage.",
            "category": "Software",
            "priority": "2",
            "risk": "medium"
          }
      continueOnError: false  # Ensure the pipeline stops if the change request creation fails

    - script: |
        echo "Deploying the project..."
      displayName: 'Deploy the project'
